#!/bin/bash
set -euo pipefail

if [ "$(id -u)" -ne 0 ]; then
    echo "This script must be run as root" >&2
    exit 1
fi

if [ -f /etc/os-release ]; then
    . /etc/os-release
    OS="${ID}"
else
    echo "Unable to detect OS configuration." >&2
    exit 1
fi

apache_bin=""
if command -v apache2 >/dev/null 2>&1; then
    apache_bin="apache2"
elif command -v httpd >/dev/null 2>&1; then
    apache_bin="httpd"
else
    echo "Apache installation not found. Exiting."
    exit 0
fi

raw_version="$($apache_bin -v 2>&1 | grep 'Server version' | awk '{print $3}' | cut -d '/' -f 2)"
if [ -z "$raw_version" ]; then
    echo "Unable to determine Apache version." >&2
    exit 1
fi

IFS='.' read -ra ver_parts << EOF
$raw_version
EOF
major="${ver_parts[0]}"
minor="${ver_parts[1]}"
patch_raw="${ver_parts[2]}"
patch_clean="$(echo "$patch_raw" | sed 's/[^0-9].*$//')"
if [ -z "$patch_clean" ]; then
    patch_clean=0
fi

vulnerable=0
if [ "$major" -eq 2 ] && [ "$minor" -eq 2 ]; then
    if [ "$patch_clean" -lt 22 ]; then
        vulnerable=1
    fi
fi

if [ "$vulnerable" -eq 0 ]; then
    echo "Apache version $raw_version is not vulnerable. Exiting."
    exit 0
fi

case "$OS" in
    debian|ubuntu)
        export DEBIAN_FRONTEND=noninteractive
        apt-get update
        package_name="$apache_bin"
        if [ "$apache_bin" = "apache2" ]; then
            apt-get install -y --only-upgrade "apache2"
        else
            package_name="httpd"
        fi
        apt-get install -y --only-upgrade "$package_name"
        ;;
    centos|rhel|fedora|ol)
        if command -v dnf >/dev/null 2>&1; then
            dnf -y upgrade httpd
        else
            yum -y update httpd
        fi
        ;;
    *)
        echo "Unsupported OS: $OS" >&2
        exit 1
        ;;
esac

if command -v systemctl >/dev/null 2>&1; then
    systemctl restart "$apache_bin"
elif command -v service >/dev/null 2>&1; then
    service "$apache_bin" restart
else
    echo "Unable to restart Apache service automatically." >&2
    echo "Please restart Apache manually to apply the changes." >&2
fi