#!/bin/bash

if [ "$(id -u)" -ne 0 ]; then
    echo "Error: This script must be run as root." >&2
    exit 1
fi

current_version=$(dpkg-query -W -f='${Version}' apache2 2>/dev/null || printf '')
if [ -z "$current_version" ]; then
    echo "apache2 is not installed. Exiting." >&2
    exit 0
fi

MIN_VERSION="2.2.22"

if dpkg --compare-versions "$current_version" ge "$MIN_VERSION"; then
    exit 0
fi

apt-get update || echo "Warning: Failed to update package lists. Attempting to proceed with update." >&2

if ! apt-get install --only-upgrade apache2 -y; then
    echo "Error: Failed to upgrade apache2." >&2
    exit 1
fi

current_version=$(dpkg-query -W -f='${Version}' apache2 2>/dev/null || printf '')
if [ -z "$current_version" ]; then
    echo "Error: apache2 package not found after upgrade." >&2
    exit 1
fi

if dpkg --compare-versions "$current_version" lt "$MIN_VERSION"; then
    echo "Error: Apache2 version is still $current_version after upgrade." >&2
    exit 1
fi