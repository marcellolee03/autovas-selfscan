#!/bin/bash
set -euo pipefail

if [ "$(id -u)" -ne 0 ]; then
    echo "This script must be run as root" >&2
    exit 1
fi

if ! dpkg-query -W -f='${Status}' apache2 >/dev/null 2>&1 | grep -q "ok installed"; then
    exit 0
fi

installed_version=$(dpkg-query -W -f='${Version}' apache2)

upstream_version=${installed_version#*:}
upstream_version=${upstream_version%-*}

IFS='.' read -r -a ver_parts <<< "$upstream_version"
if [ "${#ver_parts[@]}" -ge 2 ]; then
    major_minor="${ver_parts[0]}.${ver_parts[1]}"
else
    exit 0
fi

if [[ "$major_minor" == "2.2" ]]; then
    set +e
    dpkg --compare-versions "$installed_version" lt "2.2.22"
    cmp_result=$?
    set -e

    if [ "$cmp_result" -eq 0 ]; then
        apt-get update -qq
        DEBIAN_FRONTEND=noninteractive apt-get install -y --only-upgrade apache2 >/dev/null
    fi
fi

exit 0