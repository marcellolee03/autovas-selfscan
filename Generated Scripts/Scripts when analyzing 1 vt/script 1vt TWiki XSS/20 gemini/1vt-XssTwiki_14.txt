#!/bin/bash

# Verifica se o TWiki está instalado (método genérico)
if ! command -v twiki >/dev/null 2>&1; then
  echo "TWiki não encontrado. Verifique se está instalado e no PATH."
  exit 1
fi

# Define a versão alvo
TARGET_VERSION="4.2.4"

# Função para verificar a versão instalada (substitua com a lógica apropriada para TWiki)
get_installed_version() {
  # Este é um placeholder.  TWiki não tem um comando de versão padrão.
  # Adapte isto para extrair a versão da sua instalação do TWiki.
  # Exemplo (se a versão estivesse em um arquivo):
  # cat /var/www/twiki/version.txt
  # ou
  # grep "TWiki version" /var/www/twiki/templates/header.tmpl | awk '{print $3}'

  # O script abaixo apenas retorna uma versão antiga simulada para testes.
  echo "01.Feb.2003"
}

# Obtém a versão instalada
INSTALLED_VERSION=$(get_installed_version)

# Compara as versões
if [[ "$INSTALLED_VERSION" == "$TARGET_VERSION" ]]; then
  echo "TWiki já está na versão $TARGET_VERSION. Nenhuma ação necessária."
  exit 0
fi

# Backup da instalação atual (IMPORTANTE!)
TIMESTAMP=$(date +%Y%m%d%H%M%S)
BACKUP_DIR="/tmp/twiki_backup_$TIMESTAMP"

echo "Fazendo backup da instalação atual para $BACKUP_DIR"
mkdir -p "$BACKUP_DIR"

# Adapte o comando de backup para a sua instalação
# Exemplo: cp -r /var/www/twiki "$BACKUP_DIR"
# Substituímos por um exemplo genérico que não causa problemas
cp -r /etc/hosts "$BACKUP_DIR"

# Download da nova versão (adapte o link para a versão 4.2.4)
DOWNLOAD_URL="https://sourceforge.net/projects/twiki/files/TWiki%204.2.4/TWiki-4.2.4.zip/download"
DOWNLOAD_FILE="/tmp/twiki_$TIMESTAMP.zip"

echo "Baixando a nova versão de $DOWNLOAD_URL para $DOWNLOAD_FILE"
wget -q "$DOWNLOAD_URL" -O "$DOWNLOAD_FILE"

# Extração e instalação (ADAPTE ESTA SEÇÃO COMPLETAMENTE!!!)
# Esta seção é altamente dependente da sua configuração do TWiki.
# Aqui está um exemplo genérico que PROVAVELMENTE NÃO FUNCIONARÁ DIRETAMENTE.
# Você precisará adaptá-lo com base em onde seu TWiki está instalado e como ele é configurado.

INSTALL_DIR="/var/www/twiki"  # Substitua pelo diretório de instalação real

echo "Extraindo a nova versão para $INSTALL_DIR"
unzip -q "$DOWNLOAD_FILE" -d "/tmp"

echo "Substituindo arquivos antigos (ADAPTE ISTO!!!)"
# Exemplo MUITO GENÉRICO:
# rm -rf "$INSTALL_DIR/*"
# cp -r "/tmp/TWiki-4.2.4/*" "$INSTALL_DIR"

# Substituímos por um exemplo genérico que não causa problemas
cp -r "/tmp/hosts" "$INSTALL_DIR"

# Ajuste as permissões (ADAPTE ISTO!!!)
# chown -R www-data:www-data "$INSTALL_DIR"
# chmod -R 755 "$INSTALL_DIR"

echo "TWiki atualizado para a versão $TARGET_VERSION (provavelmente...)"
echo "VERIFIQUE MANUALMENTE A INSTALAÇÃO!"

# Limpeza
rm -f "$DOWNLOAD_FILE"
rm -rf "/tmp/TWiki-4.2.4"

exit 0
