#!/bin/bash

if command -v apt-get &>/dev/null; then
    # Update package lists and check for TWiki package availability
    sudo DEBIAN_FRONTEND=noninteractive apt-get update -qy
    pkg_status=$(apt-cache policy twiki | grep "Installed")
    
    if [[ "$pkg_status" == *"(none)"* ]]; then
        echo "TWiki not installed via package manager. Manual upgrade required." >&2
        exit 1
    fi

    # Check installed version against fixed version
    installed_ver=$(dpkg -l twiki | awk '$1=="ii" {print $3}')
    if dpkg --compare-versions "$installed_ver" ge "4.2.4"; then
        exit 0
    fi

    # Perform non-interactive upgrade
    sudo DEBIAN_FRONTEND=noninteractive apt-get install --only-upgrade -qy twiki
    exit $?

elif command -v yum &>/dev/null; then
    # Check if TWiki is managed by yum
    if ! yum list installed twiki &>/dev/null; then
        echo "TWiki not installed via package manager. Manual upgrade required." >&2
        exit 1
    fi

    # Compare versions using --nogpgcheck to bypass potential key issues
    if yum --nogpgcheck list updates twiki | grep -q 'twiki.*4.2.4'; then
        sudo yum --nogpgcheck -y -q update twiki
    fi
    exit $?

else
    echo "Unsupported package manager. Manual upgrade required." >&2
    exit 1
fi