#!/bin/sh
set -e

BACKUP_DIR="/var/backups/ubuntu_eol_upgrade"
mkdir -p "$BACKUP_DIR"

# Backup critical files
cp /etc/apt/sources.list "$BACKUP_DIR/sources.list.bak"
cp -r /etc/apt/sources.list.d "$BACKUP_DIR" || true
dpkg --get-selections > "$BACKUP_DIR/dpkg_selections.bak"

# Configure repositories for upgrade path
echo "deb http://old-releases.ubuntu.com/ubuntu hardy main restricted universe multiverse" > /etc/apt/sources.list
echo "deb http://old-releases.ubuntu.com/ubuntu hardy-updates main restricted universe multiverse" >> /etc/apt/sources.list
echo "deb http://old-releases.ubuntu.com/ubuntu hardy-security main restricted universe multiverse" >> /etc/apt/sources.list

# Update package lists
apt-get update -y

# Install upgrade tools and dependencies
apt-get install -y update-manager-core ubuntu-keyring

# Perform release upgrade non-interactively
do-release-upgrade -y -f DistUpgradeViewNonInteractive -p