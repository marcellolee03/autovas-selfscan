#!/bin/bash

CONF_FILES=()
SEARCH_PATHS=("/etc/postgresql" "/var/lib/pgsql" "/var/lib/postgresql")
for path in "${SEARCH_PATHS[@]}"; do
    while IFS= read -r -d $'\0' file; do
        CONF_FILES+=("$file")
    done < <(find "$path" -name "postgresql.conf" -print0 2>/dev/null)
done

for conf in "${CONF_FILES[@]}"; do
    if grep -qP "^\s*ssl_min_protocol_version\b" "$conf"; then
        sed -i -E 's/^(\s*ssl_min_protocol_version\s*=\s*).*$/\1'"'TLSv1.2'/" "$conf"
    else
        echo "ssl_min_protocol_version = 'TLSv1.2'" >> "$conf"
    fi
done

if pgrep postgres >/dev/null; then
    if command -v systemctl >/dev/null; then
        for service in $(systemctl list-unit-files 'postgresql*' --no-legend 2>/dev/null | awk '{print $1}' | grep -oE '^[^@]+@@?[^@\.]+|^[^\\.]+$'); do
            systemctl reload "$service" 2>/dev/null || systemctl restart "$service" 2>/dev/null || true
        done
    elif command -v pg_lsclusters >/dev/null; then
        pg_lsclusters -h | awk '/online$/ {print $1, $2}' | while read ver clu; do
            pg_ctlcluster "$ver" "$clu" reload 2>/dev/null || true
        done
    else
        pkill -HUP postgres 2>/dev/null || true
    fi
fi

exit 0