#!/bin/bash
set -e
config_file=$(sudo -u postgres psql -t -c "SHOW config_file" | tr -d '[:space:]' 2>/dev/null || true)
if [ -z "$config_file" ] || [ ! -f "$config_file" ]; then
    possible_paths=(
        "/etc/postgresql/*/main/postgresql.conf"
        "/var/lib/pgsql/data/postgresql.conf"
        "/var/lib/pgsql/*/data/postgresql.conf"
    )
    found=0
    for path in "${possible_paths[@]}"; do
        expanded=$(ls $path 2>/dev/null || true)
        if [ -n "$expanded" ] && [ -f "$expanded" ]; then
            config_file=$(echo "$expanded" | head -n1)
            found=1
            break
        fi
    done
    if [ "$found" -eq 0 ]; then
        echo "Nao foi possivel localizar o postgresql.conf" >&2
        exit 1
    fi
fi
cp -p "$config_file" "${config_file}.backup_$(date +%Y%m%d%H%M%S)"
if grep -q "^ssl_min_protocol_version" "$config_file"; then
    sed -i 's/^ssl_min_protocol_version.*/ssl_min_protocol_version = '"'TLSv1.2'"'/' "$config_file"
else
    echo "ssl_min_protocol_version = 'TLSv1.2'" >> "$config_file"
fi
if command -v systemctl >/dev/null; then
    systemctl restart postgresql
else
    service postgresql restart
fi