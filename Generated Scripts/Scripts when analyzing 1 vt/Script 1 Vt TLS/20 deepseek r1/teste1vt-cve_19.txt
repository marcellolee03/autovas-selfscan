#!/bin/bash

set -euo pipefail

if ! command -v openssl &>/dev/null; then
  echo "openssl not found. Exiting." >&2
  exit 1
fi

if [ -d /etc/crypto-policies/back-ends ]; then
  update-crypto-policies --set DEFAULT >/dev/null
  echo "System-wide crypto policies updated to DEFAULT profile"
fi

if [ -d /etc/ssl/certs ]; then
  ssl_configs=$(grep -rlE '^[# ]*SSLProtocol' /etc/ssl/certs || true)
  for config in $ssl_configs; do
    if grep -q '^[# ]*SSLProtocol' "$config"; then
      sed -i -E 's/^[# ]*SSLProtocol.*/SSLProtocol all -TLSv1 -TLSv1.1 -SSLv3/' "$config"
    else
      echo 'SSLProtocol all -TLSv1 -TLSv1.1 -SSLv3' >> "$config"
    fi
    echo "Updated protocol settings in: $config"
  done
fi

if curl -V &>/dev/null; then
  if [ -f /etc/ssl/curlrc ]; then
    cfg="/etc/ssl/curlrc"
  elif [ -f ~/.curlrc ]; then
    cfg=~/.curlrc"
  else
    cfg="/etc/skel/.curlrc"
    touch "$cfg"
  fi
  if ! grep -q '^tls-max' "$cfg"; then
    echo 'tls-max = 1.3' >> "$cfg"
    echo "Curl TLS maximum version set to 1.3 in $cfg"
  fi
fi

echo "TLS protocol restrictions applied system-wide"