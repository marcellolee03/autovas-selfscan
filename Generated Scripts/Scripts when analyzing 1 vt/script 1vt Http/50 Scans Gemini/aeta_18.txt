#!/bin/bash

# Este script implementa uma solução para mitigar a vulnerabilidade de transmissão
# de informações sensíveis em texto plano via HTTP, forçando o redirecionamento
# para HTTPS. Este script assume que você está usando o Apache como servidor web.
# Adapte o script conforme necessário para outros servidores web.

# Variáveis
HTTP_PORT=80
HTTPS_PORT=443
APACHE_CONFIG_DIR="/etc/apache2/sites-available" # Caminho padrão, ajuste se necessário

# Função para verificar se o Apache está instalado
check_apache() {
  if ! command -v apache2ctl &> /dev/null; then
    echo "Apache não encontrado. Por favor, instale o Apache antes de executar este script."
    exit 1
  fi
}

# Função para habilitar o módulo rewrite do Apache
enable_rewrite_module() {
  if ! a2enmod rewrite &> /dev/null; then
    echo "Falha ao habilitar o módulo rewrite do Apache."
    exit 1
  fi
  echo "Módulo rewrite do Apache habilitado."
}

# Função para criar um arquivo de configuração virtualhost para redirecionamento HTTP para HTTPS
create_redirect_virtualhost() {
  VIRTUALHOST_FILE="000-default.conf" #Nome do arquivo de configuração
  VIRTUALHOST_PATH="$APACHE_CONFIG_DIR/$VIRTUALHOST_FILE"

  # Verifica se o arquivo de configuração existe
  if [ ! -f "$VIRTUALHOST_PATH" ]; then
    echo "Arquivo de configuração VirtualHost padrão não encontrado: $VIRTUALHOST_PATH"
    echo "Verifique a configuração do seu Apache e ajuste a variável APACHE_CONFIG_DIR."
    exit 1
  fi

  # Cria um backup do arquivo de configuração
  cp "$VIRTUALHOST_PATH" "$VIRTUALHOST_PATH.backup"
  echo "Backup do arquivo de configuração criado: $VIRTUALHOST_PATH.backup"

  # Adiciona a configuração de redirecionamento ao arquivo
  {
  echo "<VirtualHost *:$HTTP_PORT>"
  echo "  ServerName \$(hostname -f)" #Redireciona o hostname atual
  echo "  Redirect permanent / https://\${SERVER_NAME}/"
  echo "</VirtualHost>"
  } > /tmp/redirect.conf

  cat /tmp/redirect.conf >> "$VIRTUALHOST_PATH"

  rm /tmp/redirect.conf

  echo "Configuração de redirecionamento HTTP para HTTPS adicionada a: $VIRTUALHOST_PATH"
}

# Função para reiniciar o Apache
restart_apache() {
  systemctl restart apache2
  if [ $? -eq 0 ]; then
    echo "Apache reiniciado com sucesso."
  else
    echo "Falha ao reiniciar o Apache."
    exit 1
  fi
}

# Função principal
main() {
  check_apache
  enable_rewrite_module
  create_redirect_virtualhost
  restart_apache
}

# Executa a função principal
main
exit 0
