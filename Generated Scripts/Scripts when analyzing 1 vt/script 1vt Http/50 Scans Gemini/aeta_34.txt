#!/bin/bash

# Script para mitigar a vulnerabilidade de transmissão de informações sensíveis em texto claro via HTTP.
# Este script configura o redirecionamento de HTTP para HTTPS e desabilita o acesso HTTP.

# Variáveis
HTTP_PORT=80
HTTPS_PORT=443
APACHE_CONFIG_FILE="/etc/apache2/sites-available/000-default.conf" # Caminho padrão para a configuração do Apache
APACHE_SSL_CONFIG_FILE="/etc/apache2/sites-available/default-ssl.conf" #Caminho padrão para a configuração SSL do Apache (pode variar dependendo da distro)
APACHE_DEFAULT_CONFIG="/etc/apache2/sites-available/000-default.conf"
APACHE_SSL_DEFAULT_CONFIG="/etc/apache2/sites-available/default-ssl.conf"
TEMP_FILE="/tmp/http_redirect.tmp"

# 1. Verificar se o Apache está instalado
if ! command -v apache2ctl &> /dev/null; then
  echo "Apache não está instalado. Instalando..."
  apt-get update && apt-get install -y apache2
fi

# 2. Habilitar o módulo rewrite do Apache
if ! a2enmod rewrite &> /dev/null; then
  a2enmod rewrite
fi

# 3. Criar arquivo de configuração virtual para redirecionamento HTTP para HTTPS
echo "<VirtualHost *:${HTTP_PORT}>
    ServerName \$(hostname)
    Redirect permanent / https://\${SERVER_NAME}\${REQUEST_URI}
</VirtualHost>" > ${TEMP_FILE}

# 4. Desabilitar a configuração padrão HTTP
a2dissite 000-default.conf

# 5. Habilitar o novo site de redirecionamento
cp ${TEMP_FILE} /etc/apache2/sites-available/http_redirect.conf
a2ensite http_redirect.conf

# 6. Reiniciar o Apache para aplicar as mudanças
systemctl restart apache2

echo "Redirecionamento HTTP para HTTPS configurado. Acesso HTTP desabilitado."

rm ${TEMP_FILE}
exit 0
