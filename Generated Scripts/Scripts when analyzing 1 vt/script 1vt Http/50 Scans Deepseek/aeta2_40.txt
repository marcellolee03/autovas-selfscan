#!/bin/bash
if [[ ! -f /etc/apache2/sites-available/default-ssl.conf ]]; then
    apt-get update
    apt-get install -y apache2
    a2enmod ssl
    systemctl restart apache2
fi
if [[ ! -f /etc/ssl/certs/apache-selfsigned.crt ]]; then
    openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout /etc/ssl/private/apache-selfsigned.key -out /etc/ssl/certs/apache-selfsigned.crt -subj "/CN=localhost"
fi
if ! grep -q "SSLEngine on" /etc/apache2/sites-available/default-ssl.conf; then
    echo "<VirtualHost *:443>
    ServerAdmin webmaster@localhost
    DocumentRoot /var/www/html
    SSLEngine on
    SSLCertificateFile /etc/ssl/certs/apache-selfsigned.crt
    SSLCertificateKeyFile /etc/ssl/private/apache-selfsigned.key
    <Directory /var/www/html>
        AllowOverride All
    </Directory>
    ErrorLog ${APACHE_LOG_DIR}/error.log
    CustomLog ${APACHE_LOG_DIR}/access.log combined
</VirtualHost>" > /etc/apache2/sites-available/default-ssl.conf
fi
if ! a2ensite default-ssl.conf; then
    echo "Failed to enable default-ssl site."
    exit 1
fi
if ! grep -q "Redirect permanent / https://" /etc/apache2/sites-available/000-default.conf; then
    sed -i '/<VirtualHost \*:80>/a \\tRedirect permanent / https://localhost/' /etc/apache2/sites-available/000-default.conf
fi
systemctl restart apache2