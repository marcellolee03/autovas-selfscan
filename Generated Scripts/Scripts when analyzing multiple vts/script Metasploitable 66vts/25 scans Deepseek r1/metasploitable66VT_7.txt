#!/bin/bash

# Disable inetd services
inetd_services=("rlogin" "rexec" "rsh" "telnet")
if [ -f /etc/inetd.conf ]; then
    for svc in "${inetd_services[@]}"; do
        sed -i "/$svc/d" /etc/inetd.conf
    done
    [ -x /etc/init.d/inetd ] && /etc/init.d/inetd stop && /etc/init.d/inetd start
fi

# Remove vsftpd
dpkg -l | grep -q vsftpd && apt-get remove -y --purge vsftpd

# Change MySQL root password
mysql -u root -e "UPDATE mysql.user SET Password=PASSWORD('$(openssl rand -base64 32)') WHERE User='root'; FLUSH PRIVILEGES;" &>/dev/null

# Change PostgreSQL user password
sudo -u postgres psql -c "ALTER USER postgres WITH PASSWORD '$(openssl rand -base64 32)';" &>/dev/null

# Disable PHP dangerous functions
php_ini=$(php5 -i 2>/dev/null | grep 'Loaded Configuration File' | cut -d'>' -f2)
if [ -f "$php_ini" ]; then
    sed -i -E "s/^(disable_functions\s*=\s*.*)/\1,exec,passthru,shell_exec,system,proc_open,popen,curl_exec,curl_multi_exec,parse_ini_file,show_source/" "$php_ini"
fi

# Apache configuration
mkdir -p /etc/apache2/ssl
openssl req -x509 -nodes -days 3650 -newkey rsa:2048 -keyout /etc/apache2/ssl/apache.key -out /etc/apache2/ssl/apache.crt -subj "/C=XX/L=Default/O=Unknown/CN=localhost" &>/dev/null

aptitude install -y apache2 apache2.2-common apache2-mpm-prefork apache2-utils libexpat1 ssl-cert

cat <<EOF > /etc/apache2/conf.d/security.conf
TraceEnable off
<Location />
    <LimitExcept GET POST OPTIONS>
        Deny from all
    </LimitExcept>
</Location>
EOF
if [ -d "/doc" ]; then
    echo "<Directory /doc>
    AllowOverride None
    Order deny,allow
    Deny from all
</Directory>" >> /etc/apache2/conf.d/security.conf
fi
echo "SSLProtocol all -SSLv2 -SSLv3
SSLCipherSuite HIGH:!aNULL:!MD5:!EXP:!RC4:!LOW" > /etc/apache2/conf.d/ssl.conf
sed -i 's/.*Listen 80.*//g' /etc/apache2/ports.conf
service apache2 restart &>/dev/null

# SSH configuration
cat <<EOF >> /etc/ssh/sshd_config
KexAlgorithms ecdh-sha2-nistp256,ecdh-sha2-nistp384,ecdh-sha2-nistp521,diffie-hellman-group-exchange-sha256
Ciphers chacha20-poly1305@openssh.com,aes256-gcm@openssh.com,aes128-gcm@openssh.com,aes256-ctr,aes192-ctr,aes128-ctr
MACs hmac-sha2-512-etm@openssh.com,hmac-sha2-256-etm@openssh.com,hmac-sha2-512,hmac-sha2-256
HostKeyAlgorithms ssh-ed25519,rsa-sha2-512,rsa-sha2-256
EOF
service ssh restart &>/dev/null

# Disable Tomcat AJP connector
find / -name server.xml -type f -exec sed -i 's/<Connector port="8009" protocol="AJP\/1.3"/<!-- \0 -->/' {} + &>/dev/null
pkill -f tomcat &>/dev/null

# System parameters and cleanup
sysctl -w net.ipv4.tcp_timestamps=0
rm -rf /etc/init.d/vnc4server /etc/init.d/tightvncserver
dpkg --purge vnc4server tightvncserver &>/dev/null