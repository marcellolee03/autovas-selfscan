#!/bin/bash
# Stop and disable rlogin service
systemctl stop rlogin.socket
systemctl disable rlogin.socket

# Remove rsh packages
apt-get remove --purge rsh-client rsh-server -y

# Stop and disable rexec service
systemctl stop rexec.socket
systemctl disable rexec.socket

# Update TWiki to version 4.2.4 or later
apt-get update
apt-get install twiki -y

# Disable dangerous HTTP methods (PUT, DELETE, TRACE)
sed -i '/<Directory \/var\/www\/>/,/<\/Directory>/s/AllowOverride None/AllowOverride None\n\t<LimitExcept GET POST>\n\t\tDeny from all\n\t<\/LimitExcept>/' /etc/apache2/apache2.conf
systemctl restart apache2

# Disable anonymous FTP login
sed -i 's/^\(AnonymousEnable\s*YES\)/#\1/' /etc/vsftpd.conf
systemctl restart vsftpd

# Update Apache Tomcat to version 7.0.100, 8.5.51, or 9.0.31
apt-get update
apt-get install tomcat9 -y

# Update PHP to version 5.6.30 or later
apt-get update
apt-get install php5.6 -y

# Update MySQL/MariaDB and change default credentials
apt-get update
apt-get install mysql-server -y
mysql -u root -e "ALTER USER 'root'@'localhost' IDENTIFIED WITH mysql_native_password BY 'NewSecurePassword';"

# Disable SSLv3 and TLSv1.0 in Apache
sed -i 's/SSLProtocol all -SSLv3/SSLProtocol all -SSLv3 -TLSv1/g' /etc/apache2/mods-enabled/ssl.conf
systemctl restart apache2

# Disable SSLv3 and TLSv1.0 in OpenSSH
sed -i 's/^#Protocol 2/Protocol 2/' /etc/ssh/sshd_config
echo "Ciphers aes128-ctr,aes192-ctr,aes256-ctr" >> /etc/ssh/sshd_config
systemctl restart sshd

# Disable SSLv3 and TLSv1.0 in Postfix
sed -i 's/smtpd_tls_protocols = TLSv1.2, TLSv1.3/smtpd_tls_protocols = TLSv1.2, TLSv1.3\nsmtpd_tls_exclude_ciphers = EXPORT, LOW, MEDIUM, DES-CBC3-SHA, DES-EDE3-CBC-SHA, EDH-RSA-DES-CBC3-SHA/g' /etc/postfix/main.cf
service postfix restart

# Disable SSLv3 and TLSv1.0 in PostgreSQL
sed -i 's/ssl_protocols = '\''TLSv1.2'\''/ssl_protocols = '\''TLSv1.2'\''/g' /etc/postgresql/12/main/postgresql.conf
service postgresql restart