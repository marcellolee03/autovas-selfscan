#!/bin/bash

# Atualizar o sistema operacional
sudo apt-get update && sudo apt-get upgrade -y

# Desabilitar serviços desnecessários e inseguros
sudo systemctl stop rlogin
sudo systemctl disable rlogin
sudo systemctl stop rsh
sudo systemctl disable rsh
sudo systemctl stop rexec
sudo systemctl disable rexec
sudo systemctl stop vsftpd
sudo systemctl disable vsftpd
sudo systemctl stop telnet
sudo systemctl disable telnet

# Corrigir permissões de arquivos sensíveis
sudo chmod 600 /etc/passwd /etc/shadow

# Configurar o fail2ban para bloquear tentativas de força bruta
sudo apt-get install fail2ban -y
sudo systemctl enable fail2ban
sudo systemctl start fail2ban

# Configurar o SSH para maior segurança
sudo sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin no/' /etc/ssh/sshd_config
sudo sed -i 's/#PasswordAuthentication yes/PasswordAuthentication no/' /etc/ssh/sshd_config
sudo systemctl restart ssh

# Configurar o Apache para desativar métodos HTTP perigosos
sudo a2dismod cgi
sudo a2dismod status
sudo sed -i 's/Options Indexes FollowSymLinks/Options -Indexes FollowSymLinks/' /etc/apache2/apache2.conf
sudo systemctl restart apache2

# Configurar o MySQL/MariaDB para usar autenticação segura
sudo mysql_secure_installation

# Desativar SSLv3 e TLSv1.0/TLSv1.1 no Apache
sudo sed -i 's/SSLProtocol all -SSLv3 -TLSv1/SSLProtocol all -SSLv3 -TLSv1 -TLSv1.1/' /etc/apache2/mods-enabled/ssl.conf
sudo systemctl restart apache2

# Configurar o PHP para segurança adicional
sudo sed -i 's/;cgi.fix_pathinfo=1/cgi.fix_pathinfo=0/' /etc/php/7.4/apache2/php.ini
sudo systemctl restart apache2

# Configurar o VNC para usar autenticação segura
sudo sed -i 's/SecurityTypes=VncAuth/SecurityTypes=VncAuth,TLS/' /etc/vnc/config.d/common.conf
sudo systemctl restart vncserver

# Configurar o PostgreSQL para usar autenticação segura
sudo sed -i 's/host    all             all             127.0.0.1\/32            trust/host    all             all             127.0.0.1\/32            md5/' /etc/postgresql/12/main/pg_hba.conf
sudo systemctl restart postgresql

# Configurar o PHPMyAdmin para usar autenticação segura
sudo sed -i 's/$cfg['Servers'][$i]['auth_type'] = 'cookie';/$cfg['Servers'][$i]['auth_type'] = 'config';/' /etc/phpmyadmin/config.inc.php

# Configurar o Tomcat para desativar o conector AJP
sudo sed -i '/<Connector port="8009" protocol="AJP\/1.3" redirectPort="8443" \/>/d' /etc/tomcat9/server.xml
sudo systemctl restart tomcat9

# Configurar o distcc para usar autenticação
sudo sed -i 's/--allow/--allow 127.0.0.1/' /etc/default/distcc
sudo systemctl restart distcc

# Configurar o openssl para segurança adicional
sudo sed -i 's/CipherString = DEFAULT@SECLEVEL=2/CipherString = DEFAULT@SECLEVEL=2:!aNULL:!eNULL:!LOW:!3DES:!MD5:!RC4:!SHA1:!SHA256:!SHA384/' /etc/ssl/openssl.cnf

# Configurar o fail2ban para bloquear tentativas de força bruta
sudo cp /etc/fail2ban/jail.conf /etc/fail2ban/jail.local
sudo sed -i 's/bantime  = 10m/bantime  = 24h/' /etc/fail2ban/jail.local
sudo sed -i 's/findtime  = 10m/findtime  = 1h/' /etc/fail2ban/jail.local
sudo sed -i 's/maxretry = 5/maxretry = 3/' /etc/fail2ban/jail.local
sudo systemctl restart fail2ban