#!/bin/bash

# Disable rlogin and rsh services
systemctl stop rlogin 2>/dev/null
systemctl disable rlogin 2>/dev/null
systemctl stop rsh 2>/dev/null
systemctl disable rsh 2>/dev/null

# Stop and disable VNC server
systemctl stop vncserver 2>/dev/null
systemctl disable vncserver 2>/dev/null

# Disable rexec service
systemctl stop rexec 2>/dev/null
systemctl disable rexec 2>/dev/null

# Disable DRb service
systemctl stop drb 2>/dev/null
systemctl disable drb 2>/dev/null

# Disable FTP anonymous login
sed -i 's/anonymous_enable=YES/anonymous_enable=NO/' /etc/vsftpd.conf
systemctl restart vsftpd 2>/dev/null

# Disable insecure HTTP methods
if [ -f /etc/apache2/apache2.conf ]; then
    echo "<Directory /var/www/html>
    AllowMethods GET POST
    </Directory>" >> /etc/apache2/apache2.conf
    systemctl restart apache2 2>/dev/null
fi

# Disable TRACE and TRACK methods in Apache
if [ -f /etc/apache2/apache2.conf ]; then
    echo "TraceEnable Off" >> /etc/apache2/apache2.conf
    systemctl restart apache2 2>/dev/null
fi

# Disable SSLv3 and TLSv1.0 in Apache
if [ -f /etc/apache2/mods-available/ssl.conf ]; then
    sed -i 's/SSLProtocol all -SSLv3 -TLSv1 -TLSv1.1/SSLProtocol all -SSLv3 -TLSv1 -TLSv1.1/' /etc/apache2/mods-available/ssl.conf
    systemctl restart apache2 2>/dev/null
fi

# Disable weak ciphers in Apache
if [ -f /etc/apache2/mods-available/ssl.conf ]; then
    sed -i 's/SSLCipherSuite HIGH:!aNULL:!MD5/SSLCipherSuite HIGH:!aNULL:!MD5:!RC4:!3DES/' /etc/apache2/mods-available/ssl.conf
    systemctl restart apache2 2>/dev/null
fi

# Disable VRFY and EXPN in Postfix
if [ -f /etc/postfix/main.cf ]; then
    echo "disable_vrfy_command = yes" >> /etc/postfix/main.cf
    systemctl restart postfix 2>/dev/null
fi

# Disable weak SSH encryption algorithms
if [ -f /etc/ssh/sshd_config ]; then
    echo "Ciphers aes256-ctr,aes192-ctr,aes128-ctr" >> /etc/ssh/sshd_config
    echo "MACs hmac-sha2-512,hmac-sha2-256" >> /etc/ssh/sshd_config
    echo "KexAlgorithms curve25519-sha256@libssh.org,diffie-hellman-group-exchange-sha256" >> /etc/ssh/sshd_config
    systemctl restart sshd 2>/dev/null
fi

# Disable TCP timestamps
echo "net.ipv4.tcp_timestamps = 0" >> /etc/sysctl.conf
sysctl -p

# Disable ICMP timestamp replies
echo "1" > /proc/sys/net/ipv4/icmp_echo_ignore_all

# Disable PHP info exposure
find /var/www/html -name "phpinfo.php" -exec rm -f {} \;

# Disable directory browsing in Apache
if [ -f /etc/apache2/apache2.conf ]; then
    echo "<Directory /var/www/html>
    Options -Indexes
    </Directory>" >> /etc/apache2/apache2.conf
    systemctl restart apache2 2>/dev/null
fi