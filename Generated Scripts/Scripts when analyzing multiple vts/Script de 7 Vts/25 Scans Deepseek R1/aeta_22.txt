#!/bin/bash

# Correções do servidor web (vulnerabilidades 1, 4, 5, 6)
for conf_file in $(find /etc/apache2 -name '*.conf' 2>/dev/null); do
    if grep -q "Listen 80" "$conf_file"; then
        sed -i 's/^\(\s*\)\(Listen\s*80\)/\1\2\n\1Redirect permanent \/ https:\/\/%{HTTP_HOST}%{REQUEST_URI}/' "$conf_file"
    fi
    sed -i -E '/SSLEngine\s+on/ {
        a\
\    SSLProtocol all -SSLv2 -SSLv3 -TLSv1 -TLSv1.1\
\    SSLHonorCipherOrder on\
\    SSLCipherSuite ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES256-GCM-SHA384\
\    SSLInsecureRenegotiation off
    }' "$conf_file"
done

nginx_confs=$(find /etc/nginx -name '*.conf' 2>/dev/null)
for conf_file in $nginx_confs; do
    if grep -q "listen\s*80;" "$conf_file"; then
        sed -i '/listen\s*80;/i return 301 https://$host$request_uri;' "$conf_file"
    fi
    sed -i -E '/ssl_certificate\s*[/;]/ {
        a\
\    ssl_protocols TLSv1.2 TLSv1.3;\
\    ssl_ciphers ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES256-GCM-SHA384;\
\    ssl_prefer_server_ciphers on;\
\    ssl_session_tickets off;\
\    ssl_renegotiate off;
    }' "$conf_file"
done

# Reiniciar servidores web se configs foram modificadas
if command -v apache2 >/dev/null; then
    systemctl reload apache2
fi
if command -v nginx >/dev/null; then
    systemctl reload nginx
fi

# Correção DNS (vulnerabilidade 2)
if command -v named >/dev/null && [ -e /etc/bind/named.conf.options ]; then
    cp /etc/bind/named.conf.options /etc/bind/named.conf.options.bak
    if ! grep -q "recursion no;" /etc/bind/named.conf.options; then
        awk '
            /options\s*{/ {
                seen = 1;
                print;
                print "        recursion no;";
                print "        allow-transfer { none; };";
                next;
            }
            /allow-transfer/ { next }
            /recursion / { next }
            { print }
            END {
                if (!seen) {
                    print "options {";
                    print "        recursion no;";
                    print "        allow-transfer { none; };";
                    print "};"
                }
            }' /etc/bind/named.conf.options > /tmp/named.conf.tmp
        mv /tmp/named.conf.tmp /etc/bind/named.conf.options
    fi
    systemctl restart named
fi

# Correção ICMP (vulnerabilidade 3)
iptables -A INPUT -p icmp --icmp-type timestamp-request -j DROP
iptables -A OUTPUT -p icmp --icmp-type timestamp-reply -j DROP
ip6tables -A INPUT -p icmpv6 --icmpv6-type time-exceeded -j DROP
ip6tables -A OUTPUT -p icmpv6 --icmpv6-type time-exceeded -j DROP
echo iptables-persistent iptables-persistent/autosave_v4 boolean true | debconf-set-selections
echo iptables-persistent iptables-persistent/autosave_v6 boolean true | debconf-set-selections
apt-get install -y iptables-persistent
iptables-save > /etc/iptables/rules.v4
ip6tables-save > /etc/iptables/rules.v6

# Correção TCP Timestamps (vulnerabilidade 7)
echo "net.ipv4.tcp_timestamps = 0" >> /etc/sysctl.conf
sysctl -p