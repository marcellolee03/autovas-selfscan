#!/bin/bash

# Corrigir Vulnerabilidade 1: Enforce SSL/TLS for sensitive data transmission
if grep -q "Listen 80" /etc/apache2/ports.conf; then
    sed -i 's/Listen 80/# Listen 80/' /etc/apache2/ports.conf
    echo "Redirecting HTTP to HTTPS in Apache configuration"
    echo "<VirtualHost *:80>
    Redirect permanent / https://$(hostname)/
</VirtualHost>" > /etc/apache2/sites-available/000-default.conf
    systemctl restart apache2
fi

# Corrigir Vulnerabilidade 2: Disable DNS recursion
if [ -f /etc/bind/named.conf.options ]; then
    sed -i 's/recursion yes/recursion no/' /etc/bind/named.conf.options
    systemctl restart bind9
fi

# Corrigir Vulnerabilidade 3: Disable ICMP timestamp replies
echo "net.ipv4.tcp_timestamps = 0" >> /etc/sysctl.conf
sysctl -p

# Corrigir Vulnerabilidade 4: Disable TLSv1.0 and TLSv1.1
if [ -f /etc/ssl/openssl.cnf ]; then
    sed -i 's/TLSv1 TLSv1.1 #/# TLSv1 TLSv1.1 #/' /etc/ssl/openssl.cnf
    systemctl restart apache2
fi

# Corrigir Vulnerabilidade 5: Disable SSL/TLS renegotiation
if [ -f /etc/ssl/openssl.cnf ]; then
    echo "SSLProtocol all -SSLv3 -TLSv1 -TLSv1.1" >> /etc/apache2/mods-enabled/ssl.conf
    systemctl restart apache2
fi

# Corrigir Vulnerabilidade 6: Disable weak SSL/TLS cipher suites
if [ -f /etc/ssl/openssl.cnf ]; then
    echo "SSLCipherSuite HIGH:!aNULL:!MD5:!RC4:!3DES" >> /etc/apache2/mods-enabled/ssl.conf
    systemctl restart apache2
fi

# Corrigir Vulnerabilidade 7: Disable TCP timestamps
echo "net.ipv4.tcp_timestamps = 0" >> /etc/sysctl.conf
sysctl -p