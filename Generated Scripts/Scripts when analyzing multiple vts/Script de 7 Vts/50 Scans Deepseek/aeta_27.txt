#!/bin/bash

# Vulnerabilidade 1: Cleartext Transmission of Sensitive Information via HTTP
if ! grep -q "Listen 443" /etc/apache2/ports.conf; then
    echo "Listen 443" >> /etc/apache2/ports.conf
fi
if ! grep -q "Redirect permanent / https://" /etc/apache2/sites-available/000-default.conf; then
    sed -i '/<VirtualHost \*:80>/a Redirect permanent / https://' /etc/apache2/sites-available/000-default.conf
fi
a2enmod ssl
systemctl restart apache2

# Vulnerabilidade 2: DNS Cache Snooping Vulnerability (UDP)
if grep -q "allow-recursion" /etc/bind/named.conf.options; then
    sed -i '/allow-recursion/d' /etc/bind/named.conf.options
fi
echo "allow-recursion { none; };" >> /etc/bind/named.conf.options
systemctl restart bind9

# Vulnerabilidade 3: ICMP Timestamp Reply Information Disclosure
echo "net.ipv4.icmp_echo_ignore_all=1" >> /etc/sysctl.conf
sysctl -p

# Vulnerabilidade 4: SSL/TLS: Deprecated TLSv1.0 and TLSv1.1 Protocol Detection
if grep -q "SSLProtocol" /etc/apache2/mods-enabled/ssl.conf; then
    sed -i 's/SSLProtocol.*/SSLProtocol -all +TLSv1.2 +TLSv1.3/' /etc/apache2/mods-enabled/ssl.conf
else
    echo "SSLProtocol -all +TLSv1.2 +TLSv1.3" >> /etc/apache2/mods-enabled/ssl.conf
fi
systemctl restart apache2

# Vulnerabilidade 5: SSL/TLS: Renegotiation DoS Vulnerability (CVE-2011-1473, CVE-2011-5094)
if grep -q "SSLInsecureRenegotiation" /etc/apache2/mods-enabled/ssl.conf; then
    sed -i 's/SSLInsecureRenegotiation.*/SSLInsecureRenegotiation off/' /etc/apache2/mods-enabled/ssl.conf
else
    echo "SSLInsecureRenegotiation off" >> /etc/apache2/mods-enabled/ssl.conf
fi
systemctl restart apache2

# Vulnerabilidade 6: SSL/TLS: Report Weak Cipher Suites
if grep -q "SSLCipherSuite" /etc/apache2/mods-enabled/ssl.conf; then
    sed -i 's/SSLCipherSuite.*/SSLCipherSuite HIGH:!aNULL:!MD5:!RC4/' /etc/apache2/mods-enabled/ssl.conf
else
    echo "SSLCipherSuite HIGH:!aNULL:!MD5:!RC4" >> /etc/apache2/mods-enabled/ssl.conf
fi
systemctl restart apache2

# Vulnerabilidade 7: TCP Timestamps Information Disclosure
echo "net.ipv4.tcp_timestamps = 0" >> /etc/sysctl.conf
sysctl -p