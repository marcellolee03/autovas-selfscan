#!/bin/bash

# Vulnerabilidade 1: Enforce SSL/TLS for sensitive data transmission
if ! grep -q "RewriteEngine On" /etc/apache2/sites-available/default-ssl.conf; then
    echo "RewriteEngine On" | sudo tee -a /etc/apache2/sites-available/default-ssl.conf
    echo "RewriteCond %{HTTPS} off" | sudo tee -a /etc/apache2/sites-available/default-ssl.conf
    echo "RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]" | sudo tee -a /etc/apache2/sites-available/default-ssl.conf
    sudo systemctl restart apache2
fi

# Vulnerabilidade 2: Disable DNS recursion
if ! grep -q "recursion no;" /etc/bind/named.conf.options; then
    echo "recursion no;" | sudo tee -a /etc/bind/named.conf.options
    sudo systemctl restart bind9
fi

# Vulnerabilidade 3: Disable ICMP timestamp replies
if ! grep -q "net.ipv4.icmp_echo_ignore_all=1" /etc/sysctl.conf; then
    echo "net.ipv4.icmp_echo_ignore_all=1" | sudo tee -a /etc/sysctl.conf
    sudo sysctl -p
fi

# Vulnerabilidade 4: Disable TLSv1.0 and TLSv1.1
if ! grep -q "SSLProtocol all -SSLv2 -SSLv3 -TLSv1 -TLSv1.1" /etc/apache2/mods-enabled/ssl.conf; then
    sudo sed -i 's/SSLProtocol.*/SSLProtocol all -SSLv2 -SSLv3 -TLSv1 -TLSv1.1/' /etc/apache2/mods-enabled/ssl.conf
    sudo systemctl restart apache2
fi

# Vulnerabilidade 5: Disable SSL/TLS renegotiation
if ! grep -q "SSLInsecureRenegotiation off" /etc/apache2/mods-enabled/ssl.conf; then
    echo "SSLInsecureRenegotiation off" | sudo tee -a /etc/apache2/mods-enabled/ssl.conf
    sudo systemctl restart apache2
fi

# Vulnerabilidade 6: Disable weak SSL/TLS cipher suites
if ! grep -q "SSLCipherSuite HIGH:!aNULL:!MD5:!RC4:!3DES" /etc/apache2/mods-enabled/ssl.conf; then
    sudo sed -i 's/SSLCipherSuite .*/SSLCipherSuite HIGH:!aNULL:!MD5:!RC4:!3DES/' /etc/apache2/mods-enabled/ssl.conf
    sudo systemctl restart apache2
fi

# Vulnerabilidade 7: Disable TCP timestamps
if ! grep -q "net.ipv4.tcp_timestamps=0" /etc/sysctl.conf; then
    echo "net.ipv4.tcp_timestamps=0" | sudo tee -a /etc/sysctl.conf
    sudo sysctl -p
fi