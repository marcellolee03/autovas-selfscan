#!/bin/bash

# Vulnerabilidade 1: Cleartext Transmission of Sensitive Information via HTTP
# Redirecionar HTTP para HTTPS
if ! grep -q "RewriteEngine On" /etc/apache2/sites-available/000-default.conf; then
    echo "<VirtualHost *:80>
    RewriteEngine On
    RewriteCond %{HTTPS} off
    RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]
</VirtualHost>" >> /etc/apache2/sites-available/000-default.conf
    systemctl restart apache2
fi

# Vulnerabilidade 2: DNS Cache Snooping Vulnerability (UDP)
# Desabilitar recursão no DNS
if grep -q "recursion yes;" /etc/bind/named.conf.options; then
    sed -i 's/recursion yes;/recursion no;/g' /etc/bind/named.conf.options
    systemctl restart bind9
fi

# Vulnerabilidade 3: ICMP Timestamp Reply Information Disclosure
# Desabilitar respostas ICMP Timestamp
echo "net.ipv4.tcp_timestamps = 0" >> /etc/sysctl.conf
sysctl -p

# Vulnerabilidade 4: SSL/TLS: Deprecated TLSv1.0 and TLSv1.1 Protocol Detection
# Desabilitar TLS 1.0 e 1.1
if ! grep -q "SSLProtocol" /etc/apache2/mods-enabled/ssl.conf; then
    sed -i '/SSLEngine on/a SSLProtocol all -SSLv2 -SSLv3 -TLSv1 -TLSv1.1' /etc/apache2/mods-enabled/ssl.conf
    systemctl restart apache2
fi

# Vulnerabilidade 5: SSL/TLS: Renegotiation DoS Vulnerability (CVE-2011-1473, CVE-2011-5094)
# Desabilitar renegociação SSL/TLS
if ! grep -q "SSLInsecureRenegotiation off" /etc/apache2/mods-enabled/ssl.conf; then
    echo "SSLInsecureRenegotiation off" >> /etc/apache2/mods-enabled/ssl.conf
    systemctl restart apache2
fi

# Vulnerabilidade 6: SSL/TLS: Report Weak Cipher Suites
# Remover cifras fracas
if ! grep -q "SSLCipherSuite" /etc/apache2/mods-enabled/ssl.conf; then
    sed -i '/SSLEngine on/a SSLCipherSuite HIGH:!aNULL:!MD5:!RC4:!3DES' /etc/apache2/mods-enabled/ssl.conf
    systemctl restart apache2
fi

# Vulnerabilidade 7: TCP Timestamps Information Disclosure
# Desabilitar timestamps TCP
echo "net.ipv4.tcp_timestamps = 0" >> /etc/sysctl.conf
sysctl -p