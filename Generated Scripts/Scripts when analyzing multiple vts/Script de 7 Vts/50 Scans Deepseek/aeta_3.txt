#!/bin/bash

# Vulnerabilidade 1: Enforce HTTPS for sensitive data transmission
if ! grep -q "RewriteEngine On" /etc/apache2/sites-available/default.conf; then
    echo "Rewriting HTTP to HTTPS for sensitive data transmission..."
    echo "RewriteEngine On" >> /etc/apache2/sites-available/default.conf
    echo "RewriteCond %{HTTPS} off" >> /etc/apache2/sites-available/default.conf
    echo "RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]" >> /etc/apache2/sites-available/default.conf
    systemctl restart apache2
fi

# Vulnerabilidade 2: Disable DNS recursion
if ! grep -q "recursion no;" /etc/bind/named.conf.options; then
    echo "Disabling DNS recursion..."
    echo "recursion no;" >> /etc/bind/named.conf.options
    systemctl restart bind9
fi

# Vulnerabilidade 3: Block ICMP Timestamp Replies
if ! grep -q "net.ipv4.icmp_echo_ignore_all=1" /etc/sysctl.conf; then
    echo "Blocking ICMP Timestamp Replies..."
    echo "net.ipv4.icmp_echo_ignore_all=1" >> /etc/sysctl.conf
    sysctl -p
fi

# Vulnerabilidade 4: Disable deprecated TLS versions
if ! grep -q "Protocols -ALL, TLSv1.2, TLSv1.3" /etc/apache2/mods-enabled/ssl.conf; then
    echo "Disabling deprecated TLS versions..."
    sed -i '/^SSLProtocol/ s/.*/Protocols -ALL, TLSv1.2, TLSv1.3/' /etc/apache2/mods-enabled/ssl.conf
    systemctl restart apache2
fi

# Vulnerabilidade 5: Disable SSL/TLS renegotiation
if ! grep -q "SSLInsecureRenegotiation off" /etc/apache2/mods-enabled/ssl.conf; then
    echo "Disabling SSL/TLS renegotiation..."
    echo "SSLInsecureRenegotiation off" >> /etc/apache2/mods-enabled/ssl.conf
    systemctl restart apache2
fi

# Vulnerabilidade 6: Disable weak cipher suites
if ! grep -q "SSLCipherSuite HIGH:!aNULL:!MD5:!RC4:!3DES" /etc/apache2/mods-enabled/ssl.conf; then
    echo "Disabling weak cipher suites..."
    sed -i '/^SSLCipherSuite/ s/.*/SSLCipherSuite HIGH:!aNULL:!MD5:!RC4:!3DES/' /etc/apache2/mods-enabled/ssl.conf
    systemctl restart apache2
fi

# Vulnerabilidade 7: Disable TCP timestamps
if ! grep -q "net.ipv4.tcp_timestamps = 0" /etc/sysctl.conf; then
    echo "Disabling TCP timestamps..."
    echo "net.ipv4.tcp_timestamps = 0" >> /etc/sysctl.conf
    sysctl -p
fi