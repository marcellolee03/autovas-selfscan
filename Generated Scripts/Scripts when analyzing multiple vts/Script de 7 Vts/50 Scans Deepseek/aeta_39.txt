#!/bin/bash
# Corrigir vulnerabilidades de cibersegurança

# Vulnerabilidade 1: Cleartext Transmission of Sensitive Information via HTTP
# Forçar uso de HTTPS e redirecionar HTTP para HTTPS
if ! grep -q "RewriteEngine On" /etc/apache2/sites-available/000-default.conf; then
    echo 'RewriteEngine On' >> /etc/apache2/sites-available/000-default.conf
    echo 'RewriteCond %{HTTPS} off' >> /etc/apache2/sites-available/000-default.conf
    echo 'RewriteRule (.*) https://%{HTTP_HOST}%{REQUEST_URI}' >> /etc/apache2/sites-available/000-default.conf
fi
systemctl restart apache2

# Vulnerabilidade 2: DNS Cache Snooping Vulnerability (UDP)
# Desabilitar recursão no DNS
if ! grep -q "recursion no;" /etc/bind/named.conf.options; then
    sed -i '/recursion yes;/c\recursion no;' /etc/bind/named.conf.options
fi
systemctl restart bind9

# Vulnerabilidade 3: ICMP Timestamp Reply Information Disclosure
# Bloquear ICMP timestamp
iptables -A INPUT -p icmp --icmp-type timestamp-request -j DROP
iptables -A INPUT -p icmp --icmp-type timestamp-reply -j DROP

# Vulnerabilidade 4: SSL/TLS: Deprecated TLSv1.0 and TLSv1.1 Protocol Detection
# Desabilitar TLS 1.0 e 1.1
if ! grep -q "SSLProtocol" /etc/apache2/mods-enabled/ssl.conf; then
    echo 'SSLProtocol all -SSLv3 -TLSv1 -TLSv1.1' >> /etc/apache2/mods-enabled/ssl.conf
fi
systemctl restart apache2

# Vulnerabilidade 5: SSL/TLS: Renegotiation DoS Vulnerability
# Desabilitar renegociação SSL/TLS
if ! grep -q "SSLInsecureRenegotiation off" /etc/apache2/mods-enabled/ssl.conf; then
    echo 'SSLInsecureRenegotiation off' >> /etc/apache2/mods-enabled/ssl.conf
fi
systemctl restart apache2

# Vulnerabilidade 6: SSL/TLS: Report Weak Cipher Suites
# Configurar cifras seguras
if ! grep -q "SSLCipherSuite" /etc/apache2/mods-enabled/ssl.conf; then
    echo 'SSLCipherSuite HIGH:!aNULL:!MD5:!RC4' >> /etc/apache2/mods-enabled/ssl.conf
fi
systemctl restart apache2

# Vulnerabilidade 7: TCP Timestamps Information Disclosure
# Desabilitar timestamps TCP
if ! grep -q "net.ipv4.tcp_timestamps" /etc/sysctl.conf; then
    echo 'net.ipv4.tcp_timestamps = 0' >> /etc/sysctl.conf
fi
sysctl -p