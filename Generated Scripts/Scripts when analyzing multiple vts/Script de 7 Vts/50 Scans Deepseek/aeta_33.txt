#!/bin/bash

# Vulnerabilidade 1: Cleartext Transmission of Sensitive Information via HTTP
# Forçando o uso de HTTPS e redirecionando HTTP para HTTPS
sed -i 's/^<VirtualHost \*:80>/<VirtualHost *:80>\n    RewriteEngine On\n    RewriteCond %{HTTPS} off\n    RewriteRule (.*) https:\/\/%{HTTP_HOST}%{REQUEST_URI} [L,R=301]/' /etc/apache2/sites-available/000-default.conf
sed -i 's/^<VirtualHost \*:80>/<VirtualHost *:80>\n    SSLEngine on\n    SSLCertificateFile \/etc\/ssl\/certs\/ssl-cert-snakeoil.pem\n    SSLCertificateKeyFile \/etc\/ssl\/private\/ssl-cert-snakeoil.key/' /etc/apache2/sites-available/default-ssl.conf
a2enmod ssl
a2ensite default-ssl
systemctl restart apache2

# Vulnerabilidade 2: DNS Cache Snooping Vulnerability (UDP)
# Desabilitando recursão no DNS para mitigar o vazamento de cache
sed -i 's/^recursion yes/recursion no/' /etc/bind/named.conf.options
systemctl restart bind9

# Vulnerabilidade 3: ICMP Timestamp Reply Information Disclosure
# Desabilitando respostas ICMP timestamp
echo "net.ipv4.icmp_echo_ignore_all=1" >> /etc/sysctl.conf
sysctl -p

# Vulnerabilidade 4: SSL/TLS: Deprecated TLSv1.0 and TLSv1.1 Protocol Detection
# Desabilitando TLSv1.0 e TLSv1.1
sed -i 's/^SSLProtocol all -SSLv3/SSLProtocol all -SSLv3 -TLSv1 -TLSv1.1/' /etc/apache2/mods-enabled/ssl.conf
systemctl restart apache2

# Vulnerabilidade 5: SSL/TLS: Renegotiation DoS Vulnerability (CVE-2011-1473, CVE-2011-5094)
# Desabilitando renegociação de SSL/TLS
echo "SSLInsecureRenegotiation off" >> /etc/apache2/mods-enabled/ssl.conf
systemctl restart apache2

# Vulnerabilidade 6: SSL/TLS: Report Weak Cipher Suites
# Configurando apenas cifras seguras
sed -i 's/^SSLCipherSuite HIGH:!aNULL/SSLCipherSuite HIGH:!aNULL:!MD5:!RC4:!3DES/' /etc/apache2/mods-enabled/ssl.conf
systemctl restart apache2

# Vulnerabilidade 7: TCP Timestamps Information Disclosure
# Desabilitando timestamps TCP
echo "net.ipv4.tcp_timestamps = 0" >> /etc/sysctl.conf
sysctl -p