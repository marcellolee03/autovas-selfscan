if (-not ([Security.Principal.WindowsPrincipal][Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsBuiltInRole]::Administrator)) {
    Start-Process PowerShell -ArgumentList "-NoProfile -ExecutionPolicy Bypass -File `"$PSCommandPath`"" -Verb RunAs
    exit
}

$ErrorActionPreference = "Stop"

try {
    $tempDir = Join-Path -Path $env:TEMP -ChildPath ([System.IO.Path]::GetRandomFileName())
    New-Item -ItemType Directory -Path $tempDir -Force | Out-Null

    $python310Url = "https://www.python.org/ftp/python/3.10.16/python-3.10.16-amd64.exe"
    $python312Url = "https://www.python.org/ftp/python/3.12.9/python-3.12.9-amd64.exe"

    $python310Installer = "$tempDir\python-3.10.16-amd64.exe"
    $python312Installer = "$tempDir\python-3.12.9-amd64.exe"

    Invoke-WebRequest -Uri $python310Url -OutFile $python310Installer
    Invoke-WebRequest -Uri $python312Url -OutFile $python312Installer

    $process = Start-Process -Wait -PassThru -FilePath $python310Installer -ArgumentList "/quiet", "InstallAllUsers=1", "PrependPath=0", "AssociateFiles=0"
    if ($process.ExitCode -ne 0) {
        throw "Python 3.10.16 installation failed with exit code $($process.ExitCode)"
    }

    $process = Start-Process -Wait -PassThru -FilePath $python312Installer -ArgumentList "/quiet", "InstallAllUsers=1", "PrependPath=0", "AssociateFiles=0"
    if ($process.ExitCode -ne 0) {
        throw "Python 3.12.9 installation failed with exit code $($process.ExitCode)"
    }

} catch {
    $_
    exit 1
} finally {
    if (Test-Path $tempDir) {
        Remove-Item -Path $tempDir -Recurse -Force
    }
}